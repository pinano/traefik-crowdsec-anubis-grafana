services:

  # ===========================
  #  TRAEFIK
  # ===========================
  traefik:
    image: traefik:v3.6.7
    restart: always
    ports:
      - "${TRAEFIK_LISTEN_IP:-0.0.0.0}:80:80"
      - "${TRAEFIK_LISTEN_IP:-0.0.0.0}:443:443"
    networks:
      - traefik
    sysctls:
      - net.core.somaxconn=4096
      - net.ipv4.tcp_max_syn_backlog=4096
      - net.ipv4.tcp_syncookies=1
      - net.ipv4.tcp_fin_timeout=15
      - net.ipv4.tcp_tw_reuse=1
      - net.ipv4.tcp_keepalive_time=60
    environment:
      - TZ=${TZ}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik/acme.json:/acme.json
      - ./config/traefik/certs-local-dev:/certs:ro
      - ./config/traefik/traefik-generated.yaml:/traefik.yaml:ro
      # Folder for dynamic configuration generated by the Python script
      - ./config/traefik/dynamic-config:/dynamic-config:ro
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      # Restart on config change
      - "traefik.config.hash=${TRAEFIK_CONFIG_HASH}"
      # Dashboard
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      # Middleware: basic auth
      - "traefik.http.routers.traefik.middlewares=traefik-auth-middleware"
      - "traefik.http.middlewares.traefik-auth-middleware.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"
    deploy:
      resources:
        reservations:
          memory: 512M
        limits:
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "50m" # Max 50MB per log file
        max-file: "3" # Keep only 3 files (current + 2 rotated)

  # ===========================
  #  CROWDSEC
  # ===========================
  crowdsec:
    image: crowdsecurity/crowdsec:v1.7.6
    restart: unless-stopped
    profiles:
      - crowdsec
    environment:
      GID: "1000"
      COLLECTIONS: ${CROWDSEC_COLLECTIONS}
      TZ: ${TZ}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - crowdsec-db:/var/lib/crowdsec/data/
      - crowdsec-config:/etc/crowdsec/
      - ./config/crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml
      - ./config/crowdsec/profiles.yaml:/etc/crowdsec/profiles.yaml
      # Custom scenarios (User-Agent blacklist)
      - ./config/crowdsec/scenarios/user-agent-blacklist.yaml:/etc/crowdsec/scenarios/user-agent-blacklist.yaml:ro
      - ./config/crowdsec/scenarios/user-agent-blacklist.regex.txt:/var/lib/crowdsec/data/user-agent-blacklist.regex.txt:ro
      # Custom parsers (includes IP whitelist generated by start.sh)
      - ./config/crowdsec/parsers:/etc/crowdsec/parsers/s02-enrich/custom:ro
      # Add the socket to read Traefik logs directly from Docker
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik
    security_opt:
      - no-new-privileges=true
    deploy:
      resources:
        reservations:
          memory: 512M
        limits:
          memory: 1G
    healthcheck:
      test: [ "CMD", "cscli", "lapi", "status" ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ===========================
  #  REDIS ("valkey" backend for Anubis)
  # ===========================
  redis:
    image: valkey/valkey:9.0.1-alpine
    restart: unless-stopped
    command: redis-server /redis.conf --requirepass "${REDIS_PASSWORD}"
    environment:
      - TZ=${TZ}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./config/redis/redis.conf:/redis.conf:ro
      - redis_data:/data
    networks:
      - anubis-backend
      - traefik
    deploy:
      resources:
        limits:
          memory: 256M

networks:
  traefik:
    name: traefik
    external: true
  anubis-backend:
    external: true

volumes:
  redis_data:
  crowdsec-db:
  crowdsec-config:
