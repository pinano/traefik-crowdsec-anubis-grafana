services:

  # ===========================
  #  DOZZLE
  # ===========================
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: always
    networks:
      - traefik
    environment:
      - TZ=${TZ}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    deploy:
      resources:
        limits:
          cpus: 0.10
          memory: 32M
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      # Dashboard
      - "traefik.http.routers.dozzle.rule=Host(`dozzle.${DOMAIN}`)"
      - "traefik.http.routers.dozzle.entrypoints=websecure"
      - "traefik.http.routers.dozzle.tls.certresolver=le"
      # Service: Tell Traefik that Dozzle listens on internal port 8080
      - "traefik.http.services.dozzle.loadbalancer.server.port=8080"
      # Reference the authentication middleware defined in the Traefik container
      - "traefik.http.routers.dozzle.middlewares=auth-middleware@docker"

  # ===========================
  #  CTOP: Explicitly invoked with: docker compose run --rm ctop
  # ===========================
  ctop:
    image: quay.io/vektorlab/ctop:latest
    container_name: ctop
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    profiles: [ "tools" ] # Trick: This way it doesn't start automatically, only if explicitly requested

  # ===========================
  #  STACK-WATCHDOG 
  #  monitors the stack for issues:
  #    - checks acme.json and sends alert if a cert has not been renewed and is close to expiration
  #    - checks DNS records for all domains
  #    - monitors CrowdSec health and bouncer status
  # ===========================
  stack-watchdog:
    build: ./config/stack-watchdog
    container_name: stack-watchdog
    restart: unless-stopped
    # Run all check scripts in parallel with independent intervals
    # check-certs.sh: every 24h, check-dns.sh: every WATCHDOG_DNS_CHECK_INTERVAL
    # check-crowdsec.sh: every WATCHDOG_CROWDSEC_CHECK_INTERVAL (default 1h)
    entrypoint: >
      sh -c "
        # Start certificate check loop in background
        (while true; do
          sh /check-certs.sh;
          echo 'Cert check: sleeping for 24h...';
          sleep 86400;
        done) &
        # Start CrowdSec check loop in background (if enabled)
        (if [ \"\$${CROWDSEC_DISABLE}\" != \"true\" ]; then
          while true; do
            sh /check-crowdsec.sh;
            echo \"CrowdSec check: sleeping for \$${WATCHDOG_CROWDSEC_CHECK_INTERVAL:-3600}s...\";
            sleep \$${WATCHDOG_CROWDSEC_CHECK_INTERVAL:-3600};
          done
        else
          echo 'CrowdSec check DISABLED.';
        fi) &
        # Start DNS check loop in foreground
        while true; do
          sh /check-dns.sh;
          echo \"DNS check: sleeping for \$${WATCHDOG_DNS_CHECK_INTERVAL:-21600}s...\";
          sleep \$${WATCHDOG_DNS_CHECK_INTERVAL:-21600};
        done
      "
    volumes:
      - ./config/traefik/acme.json:/acme.json:ro
      - ./config/stack-watchdog/check-certs.sh:/check-certs.sh:ro
      - ./config/stack-watchdog/check-dns.sh:/check-dns.sh:ro
      - ./config/stack-watchdog/check-crowdsec.sh:/check-crowdsec.sh:ro
      - ./domains.csv:/domains.csv:ro
      # Docker socket for CrowdSec container inspection
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - WATCHDOG_TELEGRAM_BOT_TOKEN=${WATCHDOG_TELEGRAM_BOT_TOKEN}
      - WATCHDOG_TELEGRAM_RECIPIENT_ID=${WATCHDOG_TELEGRAM_RECIPIENT_ID}
      - SERVER_DOMAIN=${DOMAIN} # For customizing the alert message
      - WATCHDOG_CERT_DAYS_WARNING=${WATCHDOG_CERT_DAYS_WARNING}
      - TZ=${TZ}
      - TRAEFIK_LISTEN_IP=${TRAEFIK_LISTEN_IP}
      - WATCHDOG_DNS_CHECK_INTERVAL=${WATCHDOG_DNS_CHECK_INTERVAL:-21600}
      - WATCHDOG_CROWDSEC_CHECK_INTERVAL=${WATCHDOG_CROWDSEC_CHECK_INTERVAL:-3600}
      - CROWDSEC_CONTAINER=crowdsec
      - CROWDSEC_DISABLE=${CROWDSEC_DISABLE:-false}
    deploy:
      resources:
        limits:
          cpus: 0.10
          memory: 16M

  # ===========================
  #  ANUBIS-ASSETS
  #  serves static files for Anubis
  # ===========================
  anubis-assets:
    image: nginx:alpine3.23-slim
    container_name: anubis-assets
    restart: unless-stopped
    stop_grace_period: 20s
    volumes:
      - ./config/anubis/assets:/usr/share/nginx/html:ro
    deploy:
      resources:
        limits:
          cpus: 0.10
          memory: 32M
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.services.anubis-assets.loadbalancer.server.port=80"
      # NOTICE: We don't define routers here, we do it via global dynamic config 
      # so we don't mess this file up with complex regex

networks:
  traefik:
    name: traefik
    external: true
