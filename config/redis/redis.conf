# === REDIS CONFIG ===

# Listen on all interfaces (inside docker network)
bind 0.0.0.0
protected-mode no
port 6379

# --- MEMORY MANAGEMENT (CRITICAL) ---
# We limit Redis to 256MB. If Anubis needs more for 100 domains,
# something is weird. This protects the Host from dying by OOM.
maxmemory 256mb

# If full, delete least recently used keys (LRU).
# This way the service never stops, just forgets old sessions.
maxmemory-policy allkeys-lru

# --- PERSISTENCE (HERE IS THE MAGIC) ---
# 1. RDB (Snapshots): Save disk snapshot...
# ...if there is 1 change in 900 secs (15 min)
save 900 1
# ...if there are 10 changes in 300 secs (5 min)
save 300 10
# ...if there are 10000 changes in 60 secs (1 min)
save 60 10000

# 2. AOF (Append Only File): Log of every write.
# It is more robust than RDB. If power goes out, you lose at most 1 second.
appendonly yes
appendfilename "appendonly.aof"
# Sync disk every second (perfect balance performance/safety)
appendfsync everysec

# AOF file optimization so it doesn't grow infinitely
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# --- MISC ---
# Disable latency on inactive connections
tcp-keepalive 300
loglevel notice
