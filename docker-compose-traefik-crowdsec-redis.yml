services:

  # ===========================
  #  TRAEFIK
  # ===========================
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: always
    depends_on:
      crowdsec:
        condition: service_healthy
    ports:
      - "${TRAEFIK_LISTEN_IP:-0.0.0.0}:80:80"
      - "${TRAEFIK_LISTEN_IP:-0.0.0.0}:443:443"
    networks:
      - traefik
    sysctls:
      - net.core.somaxconn=1024
      - net.ipv4.tcp_keepalive_time=60
    environment:
      - TZ=${TZ}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config-traefik/acme.json:/acme.json
      - ./config-traefik/traefik.yml:/traefik.yml:ro
      # Folder for dynamic configuration generated by the Python script
      - ./config-traefik/dynamic-config:/dynamic-config:ro
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      # Dashboard
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.tls.certresolver=le"
      # Middleware: basic auth
      - "traefik.http.routers.traefik.middlewares=auth-middleware"
      - "traefik.http.middlewares.auth-middleware.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"
    logging:
      driver: "json-file"
      options:
        max-size: "50m" # Max 50MB per log file
        max-file: "3"   # Keep only 3 files (current + 2 rotated)

  # ===========================
  #  CROWDSEC
  # ===========================
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: crowdsec
    restart: unless-stopped
    environment:
      GID: "1000"
      COLLECTIONS: "crowdsecurity/traefik crowdsecurity/http-cve crowdsecurity/sshd"
      TZ: ${TZ}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - crowdsec-db:/var/lib/crowdsec/data/
      - crowdsec-config:/etc/crowdsec/
      - ./config-crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml
      # Add the socket to read Traefik logs directly from Docker
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik
    security_opt:
      - no-new-privileges=true
    healthcheck:
      test: ["CMD", "cscli", "lapi", "status"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ===========================
  #  REDIS ("valkey" backend for Anubis)
  # ===========================
  redis:
    image: valkey/valkey:8-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server /redis.conf --requirepass "${REDIS_PASSWORD}"
    environment:
      - TZ=${TZ}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ./config-redis/redis.conf:/redis.conf:ro
      - redis_data:/data
    networks:
      - anubis-backend
    deploy:
      resources:
        limits:
          memory: 256M

  # ===========================
  #  CERT-MONITOR 
  #  checks acme.json and sends alert if a cert
  #  has not been renewed and is close to expiration
  # ===========================
  cert-monitor:
    build: ./cert-monitor
    container_name: cert-monitor
    restart: unless-stopped
    # Install dependencies on startup to avoid maintaining a custom image
    # Script: Infinite loop running every 24h (86400 sec)
    entrypoint: >
      sh -c "while true; do 
               sh /check-certs.sh; 
               echo 'Sleeping for 24h...'; 
               sleep 86400; 
             done"
    volumes:
      - ./config-traefik/acme.json:/acme.json:ro 
      - ./config-traefik/check-certs.sh:/check-certs.sh:ro
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_RECIPIENT_ID=${TELEGRAM_RECIPIENT_ID}
      - SERVER_DOMAIN=${DOMAIN} # For customizing the alert message
      - DAYS_WARNING=${DAYS_WARNING}
      - TZ=${TZ}
    deploy:
      resources:
        limits:
          cpus: '0.05'
          memory: 32M

  # ===========================
  #  ANUBIS-ASSETS
  #  serves static files for Anubis
  # ===========================
  anubis-assets:
    image: nginx:alpine
    container_name: anubis-assets
    restart: unless-stopped
    volumes:
      - ./config-anubis/assets:/usr/share/nginx/html:ro
    deploy:
      resources:
        limits:
          cpus: 0.10
          memory: 16M
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.services.anubis-assets.loadbalancer.server.port=80"
      # NOTICE: We don't define routers here, we do it via global dynamic config 
      # so we don't mess this file up with complex regex

networks:
  traefik:
    name: traefik
    external: true
  anubis-backend:
    external: true

volumes:
  redis_data:
  crowdsec-db:
  crowdsec-config:
