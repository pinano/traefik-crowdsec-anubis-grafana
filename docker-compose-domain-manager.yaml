services:
  domain-manager:
    build: ./config/domain-manager
    restart: unless-stopped
    networks:
      - traefik
    environment:
      - DOMAIN_MANAGER_ADMIN_USER=${DOMAIN_MANAGER_ADMIN_USER}
      - DOMAIN_MANAGER_ADMIN_PASSWORD=${DOMAIN_MANAGER_ADMIN_PASSWORD}
      - FLASK_SECRET_KEY=${DOMAIN_MANAGER_SECRET_KEY}
      - DOMAIN=${DOMAIN}
      - PROJECT_NAME=${PROJECT_NAME}
      - DOMAIN_MANAGER_APP_PATH_HOST=${DOMAIN_MANAGER_APP_PATH_HOST}
      - TZ=${TZ}
      - DOMAIN_MANAGER_INTERNAL=true
      - TRAEFIK_ACME_ENV_TYPE=${TRAEFIK_ACME_ENV_TYPE}
      - DASHBOARD_SUBDOMAIN=${DASHBOARD_SUBDOMAIN}
      - APACHE_HOST_AVAILABLE=${APACHE_HOST_AVAILABLE:-false}
    working_dir: ${DOMAIN_MANAGER_APP_PATH_HOST}/config/domain-manager
    volumes:
      - ./domains.csv:${DOMAIN_MANAGER_APP_PATH_HOST}/domains.csv
      - ./.env:${DOMAIN_MANAGER_APP_PATH_HOST}/.env
      - ./.env.dist:${DOMAIN_MANAGER_APP_PATH_HOST}/.env.dist:ro
      - ./scripts:${DOMAIN_MANAGER_APP_PATH_HOST}/scripts:ro
      - ./docker-compose-traefik-crowdsec-redis.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-traefik-crowdsec-redis.yaml:ro
      - ./docker-compose-tools.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-tools.yaml:ro
      - ./docker-compose-anubis-base.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-anubis-base.yaml:ro
      - ./docker-compose-anubis-generated.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-anubis-generated.yaml
      - ./docker-compose-apache-logs.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-apache-logs.yaml:ro
      - ./docker-compose-grafana-loki-alloy.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-grafana-loki-alloy.yaml:ro
      - ./docker-compose-domain-manager.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-domain-manager.yaml:ro
      - ./config:${DOMAIN_MANAGER_APP_PATH_HOST}/config
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/hosts:/etc/hosts-host:ro
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.domain-manager.rule=Host(`${DASHBOARD_SUBDOMAIN}.${DOMAIN}`)"
      - "traefik.http.routers.domain-manager.priority=1"
      - "traefik.http.routers.domain-manager.entrypoints=websecure"
      - "traefik.http.routers.domain-manager.tls.certresolver=${TRAEFIK_CERT_RESOLVER:-}"
      - "traefik.http.services.domain-manager.loadbalancer.server.port=5000"
      # --- SSO Middlewares Definition (to be used by other services) ---
      # 1. Forward Auth: checks /auth-check
      - "traefik.http.middlewares.dashboard-auth.forwardauth.address=http://domain-manager:5000/auth-check"
      - "traefik.http.middlewares.dashboard-auth.forwardauth.trustForwardHeader=true"
      # 2. Error Page: Redirects 401 to /login
      - "traefik.http.middlewares.dashboard-error.errors.status=401"
      - "traefik.http.middlewares.dashboard-error.errors.service=domain-manager@docker"
      - "traefik.http.middlewares.dashboard-error.errors.query=/login"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  traefik:
    name: traefik
    external: true
