services:
  domain-manager:
    build: ./config/domain-manager
    container_name: domain-manager
    restart: unless-stopped
    networks:
      - traefik
    environment:
      - DOMAIN_MANAGER_ADMIN_USER=${DOMAIN_MANAGER_ADMIN_USER}
      - DOMAIN_MANAGER_ADMIN_PASSWORD=${DOMAIN_MANAGER_ADMIN_PASSWORD}
      - FLASK_SECRET_KEY=${DOMAIN_MANAGER_SECRET_KEY}
      - DOMAIN=${DOMAIN}
      - DOMAIN_MANAGER_PROJECT_NAME=${DOMAIN_MANAGER_PROJECT_NAME}
      - DOMAIN_MANAGER_APP_PATH_HOST=${DOMAIN_MANAGER_APP_PATH_HOST}
      - TZ=${TZ}
      - DOMAIN_MANAGER_INTERNAL=true
    working_dir: ${DOMAIN_MANAGER_APP_PATH_HOST}/config/domain-manager
    volumes:
      - ./domains.csv:${DOMAIN_MANAGER_APP_PATH_HOST}/domains.csv
      - ./.env:${DOMAIN_MANAGER_APP_PATH_HOST}/.env
      - ./.env.dist:${DOMAIN_MANAGER_APP_PATH_HOST}/.env.dist:ro
      - ./start.sh:${DOMAIN_MANAGER_APP_PATH_HOST}/start.sh:ro
      - ./generate-config.py:${DOMAIN_MANAGER_APP_PATH_HOST}/generate-config.py:ro
      - ./docker-compose-traefik-crowdsec-redis.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-traefik-crowdsec-redis.yaml:ro
      - ./docker-compose-tools.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-tools.yaml:ro
      - ./docker-compose-anubis-base.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-anubis-base.yaml:ro
      - ./docker-compose-anubis-generated.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-anubis-generated.yaml
      - ./docker-compose-apache-logs.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-apache-logs.yaml:ro
      - ./docker-compose-grafana-loki-alloy.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-grafana-loki-alloy.yaml:ro
      - ./docker-compose-domain-manager.yaml:${DOMAIN_MANAGER_APP_PATH_HOST}/docker-compose-domain-manager.yaml:ro
      - ./config:${DOMAIN_MANAGER_APP_PATH_HOST}/config
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.domain-manager.rule=Host(`domains.${DOMAIN}`)"
      - "traefik.http.routers.domain-manager.entrypoints=websecure"
      - "traefik.http.routers.domain-manager.tls.certresolver=le"
      - "traefik.http.services.domain-manager.loadbalancer.server.port=5000"
      # Basic Auth can be added here or handled in-app as requested
      # - "traefik.http.routers.domain-manager.middlewares=domain-manager-auth"
      # - "traefik.http.middlewares.domain-manager-auth.basicauth.users=${DOMAIN_MANAGER_DASHBOARD_AUTH}"

networks:
  traefik:
    name: traefik
    external: true
